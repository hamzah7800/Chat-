<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline GPT-2 Chatbot</title>
<style>
body { font-family: sans-serif; display:flex; justify-content:center; margin-top:50px;}
#chat { width:600px; border:1px solid #ccc; padding:15px; border-radius:8px; background:#fff;}
#messages { height:400px; overflow-y:auto; border-bottom:1px solid #ddd; padding-bottom:10px;}
.message { margin:5px 0; }
.user { text-align:right; color:blue; }
.bot { text-align:left; color:green; }
input { width:80%; padding:8px; }
button { padding:8px; }
</style>
</head>
<body>
<div id="chat">
  <div id="messages"></div>
  <input id="userInput" placeholder="Type your message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<script>
// --- Vocabulary and tiny GPT-2 char-level probabilities ---
const vocab = "abcdefghijklmnopqrstuvwxyz .,!?";
const probs = {};
const rawData = `
hello world. this is a tiny offline chatbot. it can chat a bit about anything.
how are you today? i hope you are doing well. let's talk and have some fun!
feel free to ask questions or just say hi. i try to respond in a smart way.
`;

// Build probability table from tiny dataset
for (let i = 0; i < rawData.length - 1; i++) {
  const c = rawData[i].toLowerCase();
  const next = rawData[i+1].toLowerCase();
  if (!vocab.includes(c)) continue;
  if (!probs[c]) probs[c] = {};
  if (!probs[c][next]) probs[c][next] = 0;
  probs[c][next] += 1;
}

// Normalize probabilities
function normalize(table){
  let sum = 0;
  for(let k in table) sum += table[k];
  for(let k in table) table[k] /= sum;
}

// Sample next char using probabilities
function sampleNextChar(prev){
  const table = probs[prev] || probs[" "];
  normalize(table);
  let r = Math.random();
  let acc = 0;
  for(let c in table){
    acc += table[c];
    if(r < acc) return c;
  }
  return " ";
}

// --- Conversation memory ---
let conversation = [];

// Maintain last N messages for context
const CONTEXT_LEN = 5;

// Generate reply based on conversation
function generateReply(input){
  conversation.push("User: " + input);

  // Build context string
  const context = conversation.slice(-CONTEXT_LEN).join("\n");
  
  // Start generation with last char of context or space
  let lastChar = context.slice(-1) || " ";
  let reply = "";

  for(let i=0;i<200;i++){ // generate 200 chars max
    lastChar = sampleNextChar(lastChar);
    reply += lastChar;
  }

  conversation.push("Bot: " + reply);
  return reply;
}

// Add message to chat window
function addMessage(msg, type){
  const messages = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = `message ${type}`;
  div.textContent = msg;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

// Handle sending messages
function sendMessage(){
  const inputEl = document.getElementById("userInput");
  const input = inputEl.value.trim();
  if(!input) return;
  addMessage(input, "user");
  inputEl.value = "";
  const reply = generateReply(input);
  addMessage(reply, "bot");
}
</script>
</body>
</html>
